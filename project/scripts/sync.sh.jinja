#!/usr/bin/env bash
# (C) 2023â€“present Bartosz SÅ‚awecki (bswck)
#
# Sync with bswck/skeleton.
#
# Usage:
# $ poe sync

# BEGIN https://github.com/bswck/skeleton/tree/{{_copier_answers['_commit']}}/handle-task-stage.sh
{% filter indent(width=0) %}
{% include "handle-task-stage.sh" %}
{% endfilter %}
# END https://github.com/bswck/skeleton/tree/{{_copier_answers['_commit']}}/handle-task-stage.sh

before_task() {
    if test $(git diff --name-only | grep ".*")
    then
        echo "There are uncommitted changes in the project."
        git stash push --message "Stash before syncing with {{_copier_answers['_src_path']}}"
        DID_STASH=1
    fi
}

task() {
    copier update --trust --vcs-ref ${1:-"HEAD"}
    COPIER_PPID=$!
    LAST_REF_KEY=$COPIER_PPID"_skeleton_last_ref"
    PROJECT_PATH_KEY=$COPIER_PPID"_skeleton_project_path"
}

after_task() {
    cd $PROJECT_PATH

    echo "Previous skeleton revision: $LAST_REF"
    echo "Current skeleton revision: {{_copier_answers['_commit']}}"

    REVISION_PARAGRAPH="Skeleton revision: https://github.com/bswck/skeleton/tree/{{_copier_answers['_commit']}}"

    git add .
    if test "$LAST_REF" = "{{_copier_answers['_commit']}}"
    then
        echo "The version of the skeleton has not changed."
        git commit --no-verify -m "Patch {{_copier_conf.answers_file}} at bswck/skeleton@$LAST_REF" -m "$REVISION_PARAGRAPH"
    else
        git commit --no-verify -m "Upgrade to bswck/skeleton@{{_copier_answers['_commit']}}" -m "$REVISION_PARAGRAPH"
    fi
    git push --no-verify
    echo "Sleeping for 3 seconds..."
    sleep 3
    toggle_workflows
    if test "$DID_STASH"
    then
        echo "Unstashing changes..."
        git stash pop && echo "Done!"
    fi
}

main() {
    cd ${PROJECT_PATH:=$(git rev-parse --show-toplevel)}
    echo "--- Project path: $PROJECT_PATH"
    echo "--- Last skeleton revision: $LAST_REF"

    echo "UPDATE TASK: Syncing with bswck/skeleton."
    echo "-----------------------------------------"
    echo "Running pre-update hooks..."
    before_task
    echo
    echo "Running update..."
    task
    echo
    echo "Running post-update hooks..."
    after_task
    echo "-----------------------------------------"
    echo "UPDATE TASK COMPLETE. âœ…"
    echo
    echo "Done! ðŸŽ‰"
    echo
    echo "Your repository is now up to date with this bswck/skeleton revision:"
    echo "https://github.com/bswck/skeleton/tree/{{_copier_answers['_commit']}}"
}

main